# Система получения призов

## Настройка базы данных

Выполните SQL скрипт `add_prize_claimed_system.sql` в Supabase SQL Editor:

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте и вставьте содержимое файла `add_prize_claimed_system.sql`
4. Нажмите "Run"

## Что делает скрипт

1. **Добавляет поля в таблицу `prizes`**:

   - `claimed_at` - дата и время получения приза
   - `claimed_by` - ID пользователя, получившего приз

2. **Создает функцию `claim_prize`**:

   - Проверяет, что приз еще не получен
   - Обновляет приз как полученный с текущей датой и ID пользователя
   - Использует `SECURITY DEFINER` для обхода RLS

3. **Предоставляет права**:
   - Дает права на выполнение функции аутентифицированным пользователям

## Логика работы

### Кнопка "Получено"

- Отображается только для **партнера** (не для создателя приза)
- Видна только для **неполученных** призов
- При нажатии вызывает функцию `claim_prize` в базе данных

### Группировка призов

- **Доступные призы** - призы, которые еще не получены
- **Полученные призы** - призы, которые уже получены

### Статус приза

- **"Вы получили"** - если текущий пользователь получил приз
- **"Получено партнером"** - если партнер получил приз

## Безопасность

- Только партнер может получить приз (не создатель)
- Приз можно получить только один раз
- Функция проверяет, что приз еще не получен перед обновлением
